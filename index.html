<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor de QR Code</title>
  <!-- CDN da biblioteca html5-qrcode -->
  <script src="./html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f7f7f7;
    }
    #qr-reader {
      width: 100%;
      max-width: 500px;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: white;
    }
    #resultado {
      margin-top: 20px;
      font-size: 1.2em;
      color: #333;
    }
    #botao {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #0066cc;
      color: white;
      font-size: 1.2em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: none;
    }
    #botao:hover {
      background-color: #0055a3;
    }
  </style>
</head>
<body>

  <div>
    <h2>Leitor de QR Code</h2>
    <div id="qr-reader"></div>
    <div id="resultado">Escaneie um QR Code!</div>
    <button id="botao" onclick="abrirLink()">Abrir Página</button>
  </div>

  <script>
    // Links pré-definidos
    const linksPreDefinidos = [
      "https://example.com",
      "https://another-example.com",
      "https://yetanother.com"
    ];

    // Função para verificar se o QR Code contém um link válido
    function verificarLinkValido(decodedText) {
      return linksPreDefinidos.includes(decodedText);
    }

    // Função para exibir o botão quando um QR Code válido for escaneado
    function onScanSuccess(decodedText, decodedResult) {
      document.getElementById('resultado').textContent = 'QR Code Escaneado: ' + decodedText;

      if (verificarLinkValido(decodedText)) {
        // Exibe o botão se o link for válido
        const botao = document.getElementById('botao');
        botao.style.display = 'inline-block';
        botao.setAttribute('data-link', decodedText); // Salva o link no botão
      } else {
        document.getElementById('resultado').textContent = 'Link não válido!';
      }
    }

    // Função de erro
    function onScanError(errorMessage) {
      console.warn(`Erro de leitura: ${errorMessage}`);
    }

    // Função para abrir o link
    function abrirLink() {
      const botao = document.getElementById('botao');
      const link = botao.getAttribute('data-link');
      window.open(link, '_blank'); // Abre o link em uma nova aba
    }

    // Função para ajustar o acesso à câmera e detecção do QR Code
    function iniciarLeituraQRCode() {
      const config = {
        fps: 20,  // Aumenta os frames por segundo para melhorar a detecção
        qrbox: 300,  // Aumenta o tamanho da área de leitura
        aspectRatio: 1,  // Ajusta para manter a proporção de captura de vídeo
        disableFlip: false,  // Permite rotação, caso o dispositivo esteja deitado
      };

      const qrCodeReader = new Html5Qrcode("qr-reader");

      // Iniciar leitura com a câmera traseira ou a primeira câmera disponível
      qrCodeReader.start(
        { facingMode: "environment" },  // Preferir a câmera traseira
        config,
        onScanSuccess,
        onScanError
      ).catch(err => {
        console.error("Erro ao acessar a câmera:", err);
        document.getElementById('resultado').textContent = "Falha ao acessar a câmera.";
      });
    }

    // Função para acessar o deviceId da câmera e garantir que o dispositivo tenha uma câmera funcional
    function verificarCameras() {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const cameras = devices.filter(device => device.kind === 'videoinput');
          if (cameras.length === 0) {
            console.error("Nenhuma câmera encontrada");
            document.getElementById('resultado').textContent = "Câmera não detectada!";
          } else {
            iniciarLeituraQRCode();
          }
        })
        .catch(error => {
          console.error("Erro ao acessar os dispositivos de mídia:", error);
          document.getElementById('resultado').textContent = "Erro ao acessar as câmeras!";
        });
    }

    // Iniciar a leitura assim que a página carregar
    window.onload = () => {
      verificarCameras();
    };

  </script>

</body>
</html>
